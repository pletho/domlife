const t=Object.freeze({EVENT_REQUESTED:"event:requested",BROWSER_RECOGNIZED:"browser:recognized",SERVER_SENT:"server:sent",SERVER_PROCESSING:"server:processing",SERVER_STREAMING:"server:streaming",SERVER_RESPONDED:"server:responded",BROWSER_RECEIVING:"browser:receiving",DOM_RENDERING:"dom:rendering",CLIENT_PROCESSING:"client:processing",CLIENT_DONE:"client:done",LOADING_END:"loading:end",RETRY_WAITING:"retry:waiting"});class e{constructor(){this.map=new Map}on(t,e){return this.map.has(t)||this.map.set(t,new Set),this.map.get(t).add(e),()=>this.map.get(t).delete(e)}off(t,e){this.map.get(t)?.delete(e)}emit(t,e){this.map.get(t)?.forEach(t=>{try{t(e)}catch(t){}})}}class s{constructor(e,s=t.LOADING_END){this.bus=e,this.current=s,this.hooks=new Map}on(t,e){return this.hooks.has(t)||this.hooks.set(t,new Set),this.hooks.get(t).add(e),()=>this.hooks.get(t).delete(e)}async to(t,e={}){const s=this.current;if(s===t)return;try{window?.dispatchEvent?.(new CustomEvent("dl:state:exit",{detail:{prev:s,next:t,payload:e}}))}catch{}this.bus.emit("state:exit",{prev:s,next:t,payload:e}),this.current=t;try{window?.dispatchEvent?.(new CustomEvent("dl:state:enter",{detail:{prev:s,next:t,payload:e}})),window?.dispatchEvent?.(new CustomEvent(`dl:state:${t}`,{detail:{prev:s,next:t,payload:e}}))}catch{}this.bus.emit("state:enter",{prev:s,next:t,payload:e}),this.bus.emit("state:change",{prev:s,next:t,payload:e});const r=this.hooks.get(t);if(r)for(const i of r)try{await i({prev:s,next:t,payload:e})}catch(t){}}}class r{constructor(t=document){this.root=t,this.map=new Map}add(t,e,{ariaBusy:s=!0,spinner:r=!0}={}){const i=this.root.querySelector(e);if(!i)throw new Error("Region not found: "+e);return i.setAttribute("data-region",t),this.map.set(t,{el:i,selector:e,ariaBusy:s,spinner:r}),this}get(t){return this.map.get(t)?.el||null}setLoading(t,e=!0){const s=this.map.get(t);if(s){s.ariaBusy&&s.el.setAttribute("aria-busy",e?"true":"false"),s.spinner&&s.el.classList.toggle("dl-loading",e);try{window?.dispatchEvent?.(new CustomEvent("dl:region:loading",{detail:{id:t,on:e}}))}catch{}}}render(t,e){const s=this.get(t);if(s){s.innerHTML=e;try{window?.dispatchEvent?.(new CustomEvent("dl:region:render",{detail:{id:t}}))}catch{}}}show(t){const e=this.get(t);e&&(e.removeAttribute("aria-hidden"),e.classList.remove("hidden"))}hide(t){const e=this.get(t);e&&(e.setAttribute("aria-hidden","true"),e.classList.add("hidden"))}}class i{constructor(t=document){this.doc=t}title(t){return null!=t&&(this.doc.title=String(t)),this.doc.title}meta(t,e){let s=this.doc.querySelector(`meta[name="${t}"]`);return s||(s=this.doc.createElement("meta"),s.setAttribute("name",t),this.doc.head.appendChild(s)),s.setAttribute("content",e),s}link(t,e){let s=this.doc.querySelector(`link[rel="${t}"]`);return s||(s=this.doc.createElement("link"),s.setAttribute("rel",t),this.doc.head.appendChild(s)),s.setAttribute("href",e),s}jsonLD(t,e){let s=this.doc.getElementById(t);return s||(s=this.doc.createElement("script"),s.type="application/ld+json",s.id=t,this.doc.head.appendChild(s)),s.textContent=JSON.stringify(e),s}}class o{constructor(t=document){this.root=t}read(t,e){const{el:s,a:r}=this._r(t);if(s){if(r)return s.getAttribute(r);if("checkbox"===e)return s.checked;if("radio"===e){const t=s.name,e=this.root.querySelector(`input[type=radio][name="${t}"]:checked`);return e?.value}return s.value}}write(t,e,s){const{el:r,a:i}=this._r(t);if(r)if(i)r.setAttribute(i,String(s??""));else if("checkbox"!==e){if("radio"===e){const t=r.name;return void this.root.querySelectorAll(`input[type=radio][name="${t}"]`).forEach(t=>{t.checked=t.value===String(s)})}r.value=s??""}else r.checked=!!s}showError(t,e){const{el:s}=this._r(t);if(!s)return;s.classList.add("domlife-error"),s.setAttribute("aria-invalid","true");const r=`${s.id||s.name||"dl"}-err`;let i=this.root.getElementById(r)||this.root.querySelector("#"+r);i||(i=this.root.createElement("div"),i.id=r,i.className="domlife-error-hint",s.insertAdjacentElement("afterend",i)),i.textContent=e}clearError(t){const{el:e}=this._r(t);if(!e)return;e.classList.remove("domlife-error"),e.removeAttribute("aria-invalid");const s=`${e.id||e.name||"dl"}-err`,r=this.root.getElementById(s)||this.root.querySelector("#"+s);r?.remove?.()}_r(t){if("string"==typeof t)return{el:this.root.querySelector(t),a:null};const e=t?.selector??null,s=t?.attr??null;return{el:e?this.root.querySelector(e):null,a:s}}}const n=t=>t&&"object"==typeof t&&!Array.isArray(t),a=(t={},e={})=>{const s={...t};for(const r of Object.keys(e)){const i=t[r],o=e[r];s[r]=n(i)&&n(o)?a(i,o):o}return s},h=(t,e=250)=>{let s;return(...r)=>{clearTimeout(s),s=setTimeout(()=>t(...r),e)}},c=(t,e=200)=>new Promise(s=>setTimeout(s,e*2**t));class d{constructor({state:t,server:e,regions:s,seo:r,bus:i}){this.state=t,this.server=e,this.regions=s,this.seo=r,this.bus=i}async run({regionId:e,op:s="query",path:r="/",body:i={},render:o,timeout:n=1e4,retries:a=1}){let h;await this.state.to(t.EVENT_REQUESTED,{regionId:e,op:s}),await this.state.to(t.BROWSER_RECOGNIZED,{regionId:e,op:s}),this.regions?.setLoading(e,!0),await this.state.to(t.SERVER_SENT,{path:r}),await this.state.to(t.SERVER_PROCESSING,{});for(let o=0;o<=a;o++)try{h=await this.server[s](r,i,{timeout:n});break}catch(s){if(o===a)throw this.regions?.setLoading(e,!1),s;await this.state.to(t.RETRY_WAITING,{i:o}),await c(o)}if(await this.state.to(t.SERVER_RESPONDED,{resp:h}),await this.state.to(t.BROWSER_RECEIVING,{}),o){await this.state.to(t.DOM_RENDERING,{});try{o(h,this.regions,this.seo)}catch(t){}}return await this.state.to(t.CLIENT_PROCESSING,{}),await this.state.to(t.CLIENT_DONE,{}),this.regions?.setLoading(e,!1),await this.state.to(t.LOADING_END,{}),h}}class l{constructor({state:t,bus:e}){this.state=t,this.bus=e,this.es=null}subscribe(e,{onOpen:s,onMessage:r,onError:i,onClose:o}={}){this.es&&this.es.close(),this.es=new EventSource(e),this.state.to(t.SERVER_STREAMING,{url:e}),this.es.onopen=t=>{try{s?.(t)}catch{}},this.es.onmessage=t=>{try{r?.(t)}catch{}},this.es.onerror=t=>{try{i?.(t)}catch{}};return()=>{try{this.es?.close()}catch{}this.es=null;try{o?.()}catch{}}}}class u{constructor(){this.bus=new e,this.state=new s(this.bus),this.regions=new r(document),this.seo=new i(document),this.view=new o(document),this.server={async query(t,e){const s=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e||{})});if(!s.ok)throw new Error("HTTP "+s.status);return s.json().catch(()=>({}))},async create(t,e){return this.query(t,e)},async read(t,e){return this.query(t,e)},async update(t,e){return this.query(t,e)},async delete(t,e){return this.query(t,e)}},this.request=new d({state:this.state,server:this.server,regions:this.regions,seo:this.seo,bus:this.bus})}use({server:t,view:e,seo:s,regions:r}={}){return t&&(this.server=t),e&&(this.view=e),s&&(this.seo=s),r&&(this.regions=r),this.request=new d({state:this.state,server:this.server,regions:this.regions,seo:this.seo,bus:this.bus}),this}region(t,e,s){return this.regions.add(t,e,s),this}onState(t,e){return this.state.on(t,e)}}export{t as DL_STATE,u as DOMLifeCore,e as Emitter,r as RegionManager,d as RequestOrchestrator,i as SEOManager,l as SSEBridge,s as StateMachine,o as ViewAdapter,c as backoff,h as debounce,a as deepMerge};
//# sourceMappingURL=domlife.esm.js.map
